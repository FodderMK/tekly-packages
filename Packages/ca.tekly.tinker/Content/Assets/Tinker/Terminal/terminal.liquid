<!doctype html>
<html lang="en">

{% assign title = 'Tinker' %}
{% include tinker_head %}

<script src="https://cdn.jsdelivr.net/npm/fuzzysort@3.0.2/fuzzysort.min.js"></script>

<script src="/Tinker/terminal/commands.js"></script>
<script src="/Tinker/terminal/terminal.js"></script>
<script src="/Tinker/terminal/terminalinput.js"></script>
<script src="/Tinker/terminal/terminalsuggestion.js"></script>

<body>

<div class="main">
	{%- include tinker_sidebar -%}

	<div class="main-content terminal-page" id="terminal">
		<div class="terminal-container" id="content">
			<stats-card topic="logs/stats" class="card box-shadow"></stats-card>
		</div>
		<div class="terminal-input-container">
			<div class="terminal-suggestion hide box-shadow" id="suggestion">
			</div>
			<input id="input" class="terminal-input box-shadow" type="text" autofocus>
		</div>
	</div>
</div>


</body>

<script>

	{% assign routes = Tinker.Routes %}

    const commands = [
	{%- for route in routes -%}
	{%- assign commands = route.Functions | where: "IsCommand" -%}
	{%- for cmd in commands -%}
	{{ cmd | json }},
	{%- endfor -%}
	{%- endfor -%}
    ];
	
    function triggerReload(element) {
        let event = new Event("reload", {bubbles: true});
        element.dispatchEvent(event);
    }
	
    async function handleResponse(response) {
        const contentType = response.headers.get('Content-Type');
        if (contentType.includes('text/html')) {
            const htmlText = await response.text();

            const range = document.createRange();
            const fragment = range.createContextualFragment(htmlText);
            return fragment.firstChild;
        } else if (contentType.includes('application/json')) {
            const json = await response.text();
            const newEntry = document.createElement('pre');
            newEntry.classList.add("json", "box-shadow");
            newEntry.innerText = json;
            
            return newEntry
        } else if (contentType.includes('image/png')) {
            const blob = await response.blob();
            const objectURL = URL.createObjectURL(blob);
			
            const div = document.createElement('div');
            const a = document.createElement('a');
            a.href=response.url;
            a.target = "_blank";
            
            const img = document.createElement('img');
            img.classList.add("terminal-image");
            img.src = objectURL;
			
            img.onload = () => {
                URL.revokeObjectURL(objectURL);
            };
            
            a.appendChild(img);
            div.appendChild(a);
            
            return div;
        } else {
            return response.text();
        }
	}
	
    document.addEventListener('DOMContentLoaded', function () {
        const terminal = new Terminal("#terminal");
		
		terminal.commands.addTinkerCommands(commands);

		
        terminal.commands.addFunction("do_error", async () => {
            throw new Error("oh no!");
        });
		
        terminal.commands.addFunction("screenshot", () => {
            let url = "/screenshot?t=" + new Date().getTime();
            const text = `<div><a href="${url}" target="_blank" class="clickable-image"><img class="terminal-image" src="${url}"></a></div>`

            const range = document.createRange();
            const fragment = range.createContextualFragment(text);
            return fragment.firstChild;
        });
    });
</script>

</html>